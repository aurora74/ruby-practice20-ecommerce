<% content_for :title, t(".title", order_number: @order.order_number) %>

<div class="admin-order-details">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1">
        <%= t(".title", order_number: @order.order_number) %>
      </h1>
      <p class="text-muted">
        <%= t(".created_at", date: l(@order.created_at, format: :long)) %>
      </p>
    </div>
    <div>
      <%= link_to admin_orders_path, class: "btn btn-outline-secondary" do %>
        <i class="fas fa-arrow-left me-2"></i>
        <%= t(".back_to_orders") %>
      <% end %>
    </div>
  </div>

  <div class="row">
    <!-- Order Info & Customer Details -->
    <div class="col-lg-8">
      <!-- Order Status & Quick Actions -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-info-circle me-2"></i>
            <%= t(".order_status") %>
          </h5>
          <span class="badge fs-6 <%= order_status_badge_class(@order.status) %>">
            <%= t("orders.status.#{@order.status}") %>
          </span>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong><%= t(".payment_method") %>:</strong> 
                 <%= t("orders.payment_method.#{@order.payment_method}") %></p>
              <p><strong><%= t(".shipping_method") %>:</strong> 
                 <%= t("orders.shipping_method.#{@order.shipping_method}") %></p>
              <p><strong><%= t(".payment_status") %>:</strong> 
                 <span class="badge bg-<%= @order.payment_status_paid? ? 'success' : 'warning' %>">
                   <%= t("orders.payment_status.#{@order.payment_status}") %>
                 </span>
              </p>
            </div>
            <div class="col-md-6">
              <% if @order.cancelled_reason.present? %>
                <p><strong><%= t(".cancelled_reason") %>:</strong></p>
                <div class="alert alert-danger">
                  <%= @order.cancelled_reason %>
                </div>
              <% end %>
            </div>
          </div>
          
          <!-- Quick Actions -->
          <div class="mt-3">
            <% if @order.can_be_confirmed? %>
              <%= link_to confirm_admin_order_path(@order), "data-turbo-method": "patch",
                         class: "btn btn-success me-2",
                         data: { 
                           confirm: t(".confirm_order_message", order_number: @order.order_number)
                         } do %>
                <i class="fas fa-check me-2"></i>
                <%= t(".confirm_order") %>
              <% end %>
            <% end %>
            
            <% if @order.can_be_cancelled? %>
              <button type="button" class="btn btn-danger"
                     data-bs-toggle="modal" 
                     data-bs-target="#cancelOrderModal">
                <i class="fas fa-times me-2"></i>
                <%= t(".cancel_order") %>
              </button>
            <% end %>
            
            <!-- Status Update Dropdown -->
            <% unless @order.status_cancelled? || @order.status_delivered? %>
              <div class="btn-group ms-2">
                <button type="button" class="btn btn-primary dropdown-toggle" 
                       data-bs-toggle="dropdown">
                  <i class="fas fa-edit me-2"></i>
                  <%= t(".update_status") %>
                </button>
                <ul class="dropdown-menu">
                  <% if @order.can_be_processed? %>
                    <li>
                      <%= link_to update_status_admin_order_path(@order, status: "processing"), 
                                 "data-turbo-method": "patch", class: "dropdown-item" do %>
                        <i class="fas fa-cog me-2"></i>
                        <%= t("orders.status.processing") %>
                      <% end %>
                    </li>
                  <% end %>
                  <% if @order.can_be_confirmed? %>
                    <li>
                      <%= link_to update_status_admin_order_path(@order, status: "confirmed"), 
                                 "data-turbo-method": "patch", class: "dropdown-item" do %>
                        <i class="fas fa-check me-2"></i>
                        <%= t("orders.status.confirmed") %>
                      <% end %>
                    </li>
                  <% end %>
                  <% if @order.can_be_delivered? %>
                    <li>
                      <%= link_to update_status_admin_order_path(@order, status: "delivered"), 
                                 "data-turbo-method": "patch", class: "dropdown-item" do %>
                        <i class="fas fa-truck me-2"></i>
                        <%= t("orders.status.delivered") %>
                      <% end %>
                    </li>
                  <% end %>
                </ul>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Customer Information -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-user me-2"></i>
            <%= t(".customer_information") %>
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong><%= t(".customer_name") %>:</strong> <%= @order.recipient_name %></p>
              <p><strong><%= t(".phone") %>:</strong> <%= @order.recipient_phone %></p>
              <% if @order.user %>
                <p><strong><%= t(".email") %>:</strong> <%= @order.user.email %></p>
              <% end %>
            </div>
            <div class="col-md-6">
              <p><strong><%= t(".delivery_address") %>:</strong></p>
              <address class="mb-0">
                <%= simple_format(@order.delivery_address) %>
              </address>
            </div>
          </div>
          <% if @order.note.present? %>
            <div class="mt-3">
              <p><strong><%= t(".order_note") %>:</strong></p>
              <div class="alert alert-info">
                <%= simple_format(@order.note) %>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Order Items -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-shopping-cart me-2"></i>
            <%= t(".order_items") %>
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th><%= t(".product") %></th>
                  <th><%= t(".sku") %></th>
                  <th><%= t(".variant") %></th>
                  <th class="text-end"><%= t(".unit_price") %></th>
                  <th class="text-center"><%= t(".quantity") %></th>
                  <th class="text-end"><%= t(".total_price") %></th>
                </tr>
              </thead>
              <tbody>
                <% @order_items.each do |item| %>
                  <tr>
                    <td>
                      <div class="d-flex align-items-center">
                        <% if item.product&.images&.attached? %>
                          <%= image_tag item.product.images.first.variant(resize_to_limit: [50, 50]),
                                       class: "me-3", style: "width: 50px; height: 50px; object-fit: cover;" %>
                        <% end %>
                        <div>
                          <div class="fw-medium"><%= item.product_name %></div>
                        </div>
                      </div>
                    </td>
                    <td><%= item.product_sku %></td>
                    <td>
                      <%= item.variant_name if item.variant_name.present? %>
                    </td>
                    <td class="text-end">
                      <%= format_currency(item.unit_price) %>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-light text-dark">
                        <%= item.quantity %>
                      </span>
                    </td>
                    <td class="text-end fw-bold">
                      <%= format_currency(item.total_price) %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
              <tfoot class="table-light">
                <tr>
                  <td colspan="5" class="text-end fw-bold"><%= t(".subtotal") %>:</td>
                  <td class="text-end fw-bold"><%= format_currency(@order.subtotal_amount) %></td>
                </tr>
                <tr>
                  <td colspan="5" class="text-end"><%= t(".shipping_fee") %>:</td>
                  <td class="text-end"><%= format_currency(@order.shipping_fee) %></td>
                </tr>
                <tr class="table-primary">
                  <td colspan="5" class="text-end fw-bold fs-5"><%= t(".total") %>:</td>
                  <td class="text-end fw-bold fs-5"><%= format_currency(@order.total_amount) %></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Status History -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-history me-2"></i>
            <%= t(".status_history") %>
          </h5>
        </div>
        <div class="card-body">
          <% if @status_histories.any? %>
            <div class="timeline">
              <% @status_histories.each_with_index do |history, index| %>
                <div class="timeline-item <%= 'active' if index == 0 %>">
                  <div class="timeline-marker <%= history_status_color(history.status) %>">
                    <i class="fas <%= history_status_icon(history.status) %>"></i>
                  </div>
                  <div class="timeline-content">
                    <h6 class="mb-1">
                      <%= t("orders.status.#{history.status}") %>
                    </h6>
                    <p class="text-muted small mb-1">
                      <%= l(history.changed_at, format: :short) %>
                    </p>
                    <% if history.admin_user %>
                      <p class="text-muted small mb-1">
                        <%= t(".by_admin", admin: history.admin_user.name) %>
                      </p>
                    <% elsif history.status == "cancelled" %>
                      <p class="text-muted small mb-1">
                        <%= t(".by_customer") %>
                      </p>
                    <% else %>
                      <p class="text-muted small mb-1">
                        <%= t(".by_system") %>
                      </p>
                    <% end %>
                    <% if history.note.present? %>
                      <div class="alert alert-light small mb-0">
                        <%= simple_format(history.note) %>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-muted text-center">
              <%= t(".no_status_history") %>
            </p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Cancel Order Modal -->
<% if @order.can_be_cancelled? %>
  <div class="modal fade" id="cancelOrderModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <%= form_with url: cancel_admin_order_path(@order), method: :patch, local: true do |f| %>
          <div class="modal-header">
            <h5 class="modal-title"><%= t(".cancel_order_title") %></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <%= t(".cancel_warning", order_number: @order.order_number) %>
            </div>
            <div class="mb-3">
              <%= f.label :reason, t(".cancel_reason"), class: "form-label" %>
              <%= f.text_area :reason, class: "form-control", rows: 4, required: true,
                             placeholder: t(".cancel_reason_placeholder") %>
              <div class="form-text">
                <%= t(".cancel_reason_help") %>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <%= t("shared.cancel") %>
            </button>
            <%= f.submit t(".confirm_cancel"), class: "btn btn-danger" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<style>
  .timeline {
    position: relative;
    padding-left: 30px;
  }
  
  .timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
  }
  
  .timeline-item {
    position: relative;
    margin-bottom: 30px;
  }
  
  .timeline-item:last-child {
    margin-bottom: 0;
  }
  
  .timeline-marker {
    position: absolute;
    left: -22px;
    top: 0;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
  }
  
  .timeline-marker.bg-primary { background-color: #0d6efd !important; }
  .timeline-marker.bg-warning { background-color: #ffc107 !important; }
  .timeline-marker.bg-info { background-color: #0dcaf0 !important; }
  .timeline-marker.bg-success { background-color: #198754 !important; }
  .timeline-marker.bg-danger { background-color: #dc3545 !important; }
  
  .timeline-content {
    padding-left: 15px;
  }
  
  .timeline-item.active .timeline-marker {
    box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.2);
  }
</style>
