<% content_for :title, t(".title") %>

<div class="admin-orders-index">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1"><%= t(".title") %></h1>
      <p class="text-muted"><%= t(".subtitle") %></p>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-white bg-primary">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h5 class="card-title"><%= t(".total_orders") %></h5>
              <h2 class="mb-0"><%= @total_orders || Order.count %></h2>
            </div>
            <div class="align-self-center">
              <i class="fas fa-shopping-cart fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-warning">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h5 class="card-title"><%= t(".pending_orders") %></h5>
              <h2 class="mb-0"><%= @pending_orders || Order.pending_confirmation.count %></h2>
            </div>
            <div class="align-self-center">
              <i class="fas fa-clock fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-success">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h5 class="card-title"><%= t(".confirmed_orders") %></h5>
              <h2 class="mb-0"><%= @confirmed_orders || Order.confirmed.count %></h2>
            </div>
            <div class="align-self-center">
              <i class="fas fa-check-circle fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-info">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h5 class="card-title"><%= t(".delivered_orders") %></h5>
              <h2 class="mb-0"><%= @delivered_orders || Order.completed.count %></h2>
            </div>
            <div class="align-self-center">
              <i class="fas fa-truck fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="fas fa-filter me-2"></i>
        <%= t(".filters") %>
      </h5>
    </div>
    <div class="card-body">
      <%= form_with url: admin_orders_path, method: :get, local: true, class: "row g-3" do |f| %>
        <div class="col-md-2">
          <%= f.select :status, options_for_select([["#{t('shared.all_statuses')}", ""]] + @status_options, params[:status]),
                      {}, { class: "form-select" } %>
        </div>
        <div class="col-md-2">
          <%= f.select :payment_method, options_for_select([["#{t('shared.all_methods')}", ""]] + @payment_method_options, params[:payment_method]),
                      {}, { class: "form-select" } %>
        </div>
        <div class="col-md-2">
          <%= f.date_field :start_date, value: params[:start_date], class: "form-control", placeholder: t(".start_date") %>
        </div>
        <div class="col-md-2">
          <%= f.date_field :end_date, value: params[:end_date], class: "form-control", placeholder: t(".end_date") %>
        </div>
        <div class="col-md-2">
          <%= f.number_field :min_amount, value: params[:min_amount], class: "form-control", 
                            placeholder: t(".min_amount"), step: 0.01 %>
        </div>
        <div class="col-md-2">
          <%= f.number_field :max_amount, value: params[:max_amount], class: "form-control", 
                            placeholder: t(".max_amount"), step: 0.01 %>
        </div>
        <div class="col-12">
          <%= f.submit t(".apply_filters"), class: "btn btn-primary me-2" %>
          <%= link_to t(".clear_filters"), admin_orders_path, class: "btn btn-outline-secondary" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Orders Table -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="fas fa-list me-2"></i>
        <%= t(".orders_list") %>
      </h5>
    </div>
    <div class="card-body p-0">
      <% if @orders.any? %>
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th><%= t(".order_number") %></th>
                <th><%= t(".customer") %></th>
                <th><%= t(".total_amount") %></th>
                <th><%= t(".payment_method") %></th>
                <th><%= t(".status") %></th>
                <th><%= t(".created_at") %></th>
                <th class="text-center"><%= t(".actions") %></th>
              </tr>
            </thead>
            <tbody>
              <% @orders.each do |order| %>
                <tr>
                  <td>
                    <%= link_to order.order_number, admin_order_path(order), 
                               class: "text-decoration-none fw-bold" %>
                  </td>
                  <td>
                    <div>
                      <div class="fw-medium"><%= order.recipient_name %></div>
                      <small class="text-muted"><%= order.recipient_phone %></small>
                    </div>
                  </td>
                  <td class="fw-bold">
                    <%= format_currency(order.total_amount) %>
                  </td>
                  <td>
                    <span class="badge bg-light text-dark">
                      <%= t("orders.payment_method.#{order.payment_method}") %>
                    </span>
                  </td>
                  <td>
                    <span class="badge <%= order_status_badge_class(order.status) %>">
                      <%= t("orders.status.#{order.status}") %>
                    </span>
                  </td>
                  <td>
                    <%= l(order.created_at, format: :short) %>
                  </td>
                  <td class="text-center">
                    <div class="btn-group btn-group-sm">
                      <!-- View Details - always available -->
                      <%= link_to admin_order_path(order), class: "btn btn-outline-primary btn-sm",
                                 title: t(".view_details") do %>
                        <i class="fas fa-eye"></i>
                      <% end %>
                      
                      <% case order.status %>
                      <% when "pending" %>
                        <!-- Processing button for pending orders -->
                        <% if order.can_be_processed? %>
                          <%= link_to process_order_admin_order_path(order),
                                     class: "btn btn-outline-warning btn-sm",
                                     title: t(".process_order"),
                                     data: { 
                                       turbo_method: :patch,
                                       confirm: t(".process_order_message", order_number: order.order_number)
                                     } do %>
                            <i class="fas fa-cogs"></i>
                          <% end %>
                        <% end %>
                        
                      <% when "processing" %>
                        <!-- Confirm button for processing orders -->
                        <% if order.can_be_confirmed? %>
                          <%= link_to confirm_admin_order_path(order),
                                     class: "btn btn-outline-success btn-sm",
                                     title: t(".confirm_order"),
                                     data: { 
                                       turbo_method: :patch,
                                       confirm: t(".confirm_order_message", order_number: order.order_number)
                                     } do %>
                            <i class="fas fa-check"></i>
                          <% end %>
                        <% end %>
                        
                      <% when "confirmed" %>
                        <!-- Deliver button for confirmed orders -->
                        <% if order.can_be_delivered? %>
                          <%= link_to deliver_admin_order_path(order),
                                     class: "btn btn-outline-info btn-sm",
                                     title: t(".deliver_order"),
                                     data: { 
                                       turbo_method: :patch,
                                       confirm: t(".deliver_order_message", order_number: order.order_number)
                                     } do %>
                            <i class="fas fa-truck"></i>
                          <% end %>
                        <% end %>
                      <% end %>
                      
                      <!-- Cancel button - available for pending and processing orders -->
                      <% if order.can_be_cancelled? %>
                        <button type="button" class="btn btn-outline-danger btn-sm"
                               title="<%= t('.cancel_order') %>"
                               data-bs-toggle="modal" 
                               data-bs-target="#cancelModal<%= order.id %>">
                          <i class="fas fa-times"></i>
                        </button>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
        
        <!-- Pagination -->
        <div class="card-footer bg-white">
          <%== pagy_bootstrap_nav(@pagy) if @pagy.pages > 1 %>
        </div>
      <% else %>
        <div class="text-center py-5">
          <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
          <h5 class="text-muted"><%= t(".no_orders") %></h5>
          <p class="text-muted"><%= t(".no_orders_message") %></p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Cancel Order Modals -->
<% @orders.each do |order| %>
  <% if order.can_be_cancelled? %>
    <div class="modal fade" id="cancelModal<%= order.id %>" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <%= form_with url: cancel_admin_order_path(order), method: :patch, local: true do |f| %>
            <div class="modal-header">
              <h5 class="modal-title"><%= t(".cancel_order_title") %></h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <p><%= t(".cancel_confirmation", order_number: order.order_number) %></p>
              <div class="mb-3">
                <%= f.label :reason, t(".cancel_reason"), class: "form-label" %>
                <%= f.text_area :reason, class: "form-control", rows: 3, required: true,
                               placeholder: t(".cancel_reason_placeholder") %>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <%= t("shared.cancel") %>
              </button>
              <%= f.submit t(".confirm_cancel"), class: "btn btn-danger" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
<% end %>
