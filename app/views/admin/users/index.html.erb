<% content_for :title, t("admin.users.index.title") %>
<div class="admin-users-page">
  <div class="row">
    <div class="col-md-12">
      <div class="page-header">
        <h1><%= t("admin.users.index.title") %></h1>
        <p class="text-muted"><%= t("admin.users.index.subtitle") %></p>
      </div>
    </div>
  </div>
  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card border-primary">
        <div class="card-body text-center">
          <h3 class="text-primary"><%= @total_users %></h3>
          <p class="mb-0"><%= t("admin.users.stats.total") %></p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-success">
        <div class="card-body text-center">
          <h3 class="text-success"><%= @active_users %></h3>
          <p class="mb-0"><%= t("admin.users.stats.active") %></p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-warning">
        <div class="card-body text-center">
          <h3 class="text-warning"><%= @inactive_users %></h3>
          <p class="mb-0"><%= t("admin.users.stats.inactive") %></p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-info">
        <div class="card-body text-center">
          <h3 class="text-info"><%= @admin_users %></h3>
          <p class="mb-0"><%= t("admin.users.stats.admins") %></p>
        </div>
      </div>
    </div>
  </div>
  <!-- Search and Filter Form -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><%= t("admin.users.search.title") %></h5>
        </div>
        <div class="card-body">
          <%= form_with url: admin_users_path, method: :get, local: true, id: "search-form" do |f| %>
            <div class="row g-3">
              <div class="col-md-3">
                <%= f.text_field :search, value: params[:search],
                              placeholder: t("admin.users.search.placeholder"),
                              class: "form-control" %>
              </div>
              <div class="col-md-2">
                <%= f.select :status,
                          options_for_select(@status_options, params[:status]),
                          {}, { class: "form-select" } %>
              </div>
              <div class="col-md-2">
                <%= f.select :role,
                          options_for_select(@role_options, params[:role]),
                          {}, { class: "form-select" } %>
              </div>
              <div class="col-md-2">
                <%= f.date_field :start_date, value: params[:start_date],
                              class: "form-control",
                              placeholder: t("admin.users.filter.start_date") %>
              </div>
              <div class="col-md-2">
                <%= f.date_field :end_date, value: params[:end_date],
                              class: "form-control",
                              placeholder: t("admin.users.filter.end_date") %>
              </div>
              <div class="col-md-1">
                <%= f.submit t("admin.users.search.submit"), class: "btn btn-primary" %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
  <!-- Bulk Actions Form -->
  <%= form_with url: bulk_update_admin_users_path, method: :patch, local: true, id: "bulk-form" do |f| %>
    <div class="row mb-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0"><%= t("admin.users.bulk_actions.title") %></h5>
          </div>
          <div class="card-body">
            <div class="row g-3 align-items-end">
              <div class="col-md-3">
                <%= f.select :action_type,
                          options_for_select(@bulk_action_options),
                          {}, { class: "form-select", id: "bulk-action-select" } %>
              </div>
              <div class="col-md-4" id="reason-field" style="display: none;">
                <%= f.text_area :reason, placeholder: t("admin.users.bulk_actions.reason_placeholder"),
                             class: "form-control", rows: 2 %>
              </div>
              <div class="col-md-2">
                <%= f.submit t("admin.users.bulk_actions.submit"),
                          class: "btn btn-warning",
                          id: "bulk-submit",
                          disabled: true %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
  <!-- Users Table -->
  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><%= t("admin.users.table.title") %></h5>
        </div>
        <div class="card-body">
          <% if @users.any? %>
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>
                      <input type="checkbox" id="select-all">
                    </th>
                    <th><%= t("admin.users.table.avatar") %></th>
                    <th><%= t("admin.users.table.name") %></th>
                    <th><%= t("admin.users.table.email") %></th>
                    <th><%= t("admin.users.table.phone") %></th>
                    <th><%= t("admin.users.table.registered") %></th>
                    <th><%= t("admin.users.table.status") %></th>
                    <th><%= t("admin.users.table.role") %></th>
                    <th><%= t("admin.users.table.actions") %></th>
                  </tr>
                </thead>
                <tbody>
                  <% @users.each do |user| %>
                    <tr>
                      <td>
                        <% if user.can_be_deactivated_by?(current_user) %>
                          <input type="checkbox" name="user_ids[]" value="<%= user.id %>"
                               class="user-checkbox" form="bulk-form">
                        <% end %>
                      </td>
                      <td>
                        <% if user.avatar.attached? %>
                          <%= image_tag user.avatar, class: "img-circle", size: "40x40" %>
                        <% else %>
                          <div class="avatar-placeholder">
                            <%= user.display_name.first.upcase %>
                          </div>
                        <% end %>
                      </td>
                      <td>
                        <%= link_to user.display_name, admin_user_path(user),
                                  class: "text-primary" %>
                      </td>
                      <td><%= user.email %></td>
                      <td><%= user.phone_number %></td>
                      <td><%= l(user.created_at, format: :short) %></td>
                      <td>
                        <% if user.activated? %>
                          <span class="badge bg-success">
                            <%= t("admin.status.active") %>
                          </span>
                        <% else %>
                          <span class="badge bg-danger">
                            <%= t("admin.status.inactive") %>
                          </span>
                        <% end %>
                      </td>
                      <td>
                        <span class="badge bg-<%= user.admin? ? 'info' : 'secondary' %>">
                          <%= user.role_text %>
                        </span>
                      </td>
                      <td>
                        <%= link_to t("admin.users.actions.view"), admin_user_path(user),
                                  class: "btn btn-sm btn-outline-info" %>
                        <% if user.can_be_deactivated_by?(current_user) %>
                          <% if user.activated? %>
                            <%= button_to t("admin.users.actions.deactivate"),
                                        toggle_status_admin_user_path(user),
                                        method: :patch,
                                        class: "btn btn-sm btn-outline-warning",
                                        data: {
                                          confirm: t("admin.users.actions.deactivate_confirm", name: user.display_name)
                                        } %>
                          <% else %>
                            <%= button_to t("admin.users.actions.activate"),
                                        toggle_status_admin_user_path(user),
                                        method: :patch,
                                        class: "btn btn-sm btn-outline-success",
                                        data: {
                                          confirm: t("admin.users.actions.activate_confirm", name: user.display_name)
                                        } %>
                          <% end %>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
            <!-- Pagination -->
            <div class="text-center">
              <%== pagy_bootstrap_nav(@pagy) if @pagy.pages > 1 %>
            </div>
          <% else %>
            <div class="text-center">
              <p class="text-muted"><%= t("admin.users.table.no_users") %></p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
  <!-- Deactivate Modal -->
  <div class="modal fade" id="deactivateModal" tabindex="-1" aria-labelledby="deactivateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <%= form_with url: "", method: :patch, local: true, id: "deactivate-form" do |f| %>
          <div class="modal-header">
            <h5 class="modal-title" id="deactivateModalLabel"><%= t("admin.users.deactivate_modal.title") %></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p><%= t("admin.users.deactivate_modal.message") %> <strong id="user-name-placeholder"></strong>?</p>
            <div class="mb-3">
              <%= f.label :reason, t("admin.users.deactivate_modal.reason_label"), class: "form-label" %>
              <%= f.text_area :reason, class: "form-control", rows: 3,
                           placeholder: t("admin.users.deactivate_modal.reason_placeholder") %>
            </div>
            <%= f.hidden_field :action_type, value: "deactivate" %>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <%= t("admin.users.deactivate_modal.cancel") %>
            </button>
            <%= f.submit t("admin.users.deactivate_modal.confirm"), class: "btn btn-warning" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  <!-- JavaScript functionality moved to app/javascript/admin/users.js -->
</div>
